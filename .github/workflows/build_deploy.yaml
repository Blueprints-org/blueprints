# This workflow will upload a Python Package using Twine when a release is created
# For more information see: https://help.github.com/en/actions/language-and-framework-guides/using-python-with-github-actions#publishing-to-package-registries

# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: Test, build and deploy after release

on:
  release:
    types: [published]

env:
  UV_VERSION: 0.6.17
  DEFAULT_PYTHON_VERSION: '3.13'

jobs:
  deploy:
    name: Test and Build Python Release Package with Release Dependencies
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Check out the repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Install uv version ${{ env.UV_VERSION }}
        uses: astral-sh/setup-uv@v6
        with:
          version: ${{ env.UV_VERSION }}

      - name: Install python ${{ env.DEFAULT_PYTHON_VERSION }} using uv
        run: uv python install ${{ env.DEFAULT_PYTHON_VERSION }}

      - name: Run checks with ruff
        run: |
          uv run ruff check .

      - name: Check if code is formatted correctly
        run: |
          uv run ruff format . --check

      - name: Run type checks with mypy
        run: |
          uv run mypy

      - name: Run tests with pytest
        run: |
          uv run pytest --pspec tests/

      - name: Build package
        run: uv build

#      - name: Publish distribution to PyPI (https://pypi.org/project/blue-prints)
#        uses: pypa/gh-action-pypi-publish@release/v1
#        with:
#          user: __token__
#          password: ${{ secrets.BLUEPRINTS_PYPI_API_TOKEN }}

      - name: Publish distribution to TestPyPI (https://test.pypi.org/project/blue-prints)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.BLUEPRINTS_TEST_PYPI_API_TOKEN }}
          repository-url: https://test.pypi.org/legacy/